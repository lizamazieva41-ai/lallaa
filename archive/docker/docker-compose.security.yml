version: '3.8'

services:
  # OWASP ZAP for DAST
  zap:
    image: owasp/zap2docker-stable
    container_name: bin-check-zap
    ports:
      - "8090:8090"
    volumes:
      - ./.zap:/zap/wrk
      - ./dast-reports:/zap/reports
    environment:
      - ZAP_API_KEY=changeme
      - ZAP_HOST=0.0.0.0
    command: zap.sh -daemon -host 0.0.0.0 -port 8090 -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true
    networks:
      - security-testing
    restart: unless-stopped

  # Snyk for dependency scanning
  snyk:
    image: snyk/snyk:latest
    container_name: bin-check-snyk
    volumes:
      - .:/project
      - snyk-cache:/root/.cache/snyk
    working_dir: /project
    environment:
      - SNYK_TOKEN=${SNYK_TOKEN}
    command: monitor --org=your-org-name
    networks:
      - security-testing
    profiles:
      - scanning

  # SonarQube for SAST
  sonarqube:
    image: sonarqube:latest
    container_name: bin-check-sonarqube
    ports:
      - "9000:9000"
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://postgres:5432/sonar
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=sonar
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_logs:/opt/sonarqube/logs
      - sonarqube_extensions:/opt/sonarqube/extensions
    networks:
      - security-testing
    depends_on:
      - postgres-sonar
    restart: unless-stopped
    profiles:
      - sonar

  # PostgreSQL for SonarQube
  postgres-sonar:
    image: postgres:13
    container_name: bin-check-postgres-sonar
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - POSTGRES_DB=sonar
    volumes:
      - postgres-sonar_data:/var/lib/postgresql/data
    networks:
      - security-testing
    restart: unless-stopped
    profiles:
      - sonar

  # Trivy scanner
  trivy:
    image: aquasec/trivy:latest
    container_name: bin-check-trivy
    volumes:
      - .:/src
      - ./security-reports:/reports
      - trivy_cache:/root/.cache/trivy
    command: >
      sh -c "
        trivy fs --format json --output /reports/filesystem-scan.json /src &&
        trivy image --format json --output /reports/container-scan.json bin-check-api:latest &&
        trivy repo --format json --output /reports/repo-scan.json ./
      "
    networks:
      - security-testing
    profiles:
      - scanning

  # Application under test
  app-for-testing:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bin-check-api-test
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=test
      - DATABASE_URL=postgresql://test:test@postgres-test:5432/testdb
      - REDIS_URL=redis://redis-test:6379
    networks:
      - security-testing
    depends_on:
      - postgres-test
      - redis-test
    restart: unless-stopped
    profiles:
      - testing

  # Test database
  postgres-test:
    image: postgres:15
    container_name: bin-check-postgres-test
    environment:
      - POSTGRES_DB=testdb
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
    volumes:
      - postgres-test_data:/var/lib/postgresql/data
    networks:
      - security-testing
    restart: unless-stopped
    profiles:
      - testing

  # Test Redis
  redis-test:
    image: redis:7-alpine
    container_name: bin-check-redis-test
    ports:
      - "6379:6379"
    volumes:
      - redis-test_data:/data
    networks:
      - security-testing
    restart: unless-stopped
    profiles:
      - testing

  # Security dashboard
  security-dashboard:
    image: nginx:alpine
    container_name: bin-check-security-dashboard
    ports:
      - "8080:80"
    volumes:
      - ./security-reports:/usr/share/nginx/html/reports:ro
      - ./monitoring/grafana:/usr/share/nginx/html/grafana:ro
    networks:
      - security-testing
    restart: unless-stopped
    profiles:
      - dashboard

volumes:
  sonarqube_data:
  sonarqube_logs:
  sonarqube_extensions:
  postgres-sonar_data:
  postgres-test_data:
  redis-test_data:
  snyk-cache:
  trivy_cache:

networks:
  security-testing:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16